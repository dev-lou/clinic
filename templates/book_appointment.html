{% extends "student_base.html" %}
{% block title %}Book Appointment &mdash; ISUFST CareHub{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}

{% block content %}
<div class="space-y-6 fade-in">
    <!-- Header -->
    <div class="relative bg-gradient-to-br from-primary-800 via-primary-700 to-indigo-800 rounded-3xl p-8 sm:p-10 overflow-hidden">
        <div class="absolute top-0 right-0 w-72 h-72 bg-white/[0.04] rounded-full -translate-y-1/3 translate-x-1/4"></div>
        <div class="relative z-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-white mb-1">Book Appointment</h1>
            <p class="text-blue-200/50 text-sm">Schedule your free dental or medical check-up</p>
        </div>
    </div>

    <!-- Booking Form -->
    <form method="POST" id="bookingForm" class="space-y-6">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="appointment_date" id="selectedDate">
        <input type="hidden" name="time_slot" id="selectedTimeSlot">

        <!-- Service Type -->
        <div class="bg-white rounded-2xl border border-gray-100 p-6 sm:p-8">
            <label class="flex items-center gap-2 text-sm font-bold text-gray-700 mb-4">
                <div class="w-8 h-8 bg-primary-50 rounded-lg flex items-center justify-center"><i class="fas fa-stethoscope text-primary-600 text-sm"></i></div>
                Service Type
            </label>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <label class="relative cursor-pointer group">
                    <input type="radio" name="service_type" value="Dental" class="peer sr-only" required onchange="loadCalendar()">
                    <div class="p-6 border-2 border-gray-200 rounded-2xl peer-checked:border-primary-600 peer-checked:bg-primary-50 transition-all hover:border-primary-300 group-hover:shadow-md">
                        <i class="fas fa-tooth text-3xl text-primary-600 mb-3"></i>
                        <h3 class="font-bold text-gray-900 text-lg">Dental Care</h3>
                        <p class="text-sm text-gray-500 mt-1">Checkup, cleaning, consultation</p>
                    </div>
                </label>
                <label class="relative cursor-pointer group">
                    <input type="radio" name="service_type" value="Medical" class="peer sr-only" onchange="loadCalendar()">
                    <div class="p-6 border-2 border-gray-200 rounded-2xl peer-checked:border-primary-600 peer-checked:bg-primary-50 transition-all hover:border-primary-300 group-hover:shadow-md">
                        <i class="fas fa-user-md text-3xl text-primary-600 mb-3"></i>
                        <h3 class="font-bold text-gray-900 text-lg">Medical Care</h3>
                        <p class="text-sm text-gray-500 mt-1">Consultation, treatment, checkup</p>
                    </div>
                </label>
            </div>
        </div>

        <!-- Calendar -->
        <div class="bg-white rounded-2xl border border-gray-100 p-6 sm:p-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="flex items-center gap-2 text-lg font-bold text-gray-900">
                    <div class="w-8 h-8 bg-primary-50 rounded-lg flex items-center justify-center"><i class="fas fa-calendar text-primary-600 text-sm"></i></div>
                    Select Date
                </h2>
                <div class="flex items-center gap-2">
                    <button type="button" onclick="changeMonth(-1)" class="w-9 h-9 hover:bg-gray-100 rounded-lg flex items-center justify-center transition"><i class="fas fa-chevron-left text-gray-500"></i></button>
                    <span id="currentMonth" class="text-sm font-semibold text-gray-700 min-w-[150px] text-center"></span>
                    <button type="button" onclick="changeMonth(1)" class="w-9 h-9 hover:bg-gray-100 rounded-lg flex items-center justify-center transition"><i class="fas fa-chevron-right text-gray-500"></i></button>
                </div>
            </div>
            <div class="grid grid-cols-7 gap-2 mb-2">
                <div class="text-center text-xs font-bold text-gray-400 py-2">Sun</div>
                <div class="text-center text-xs font-bold text-gray-400 py-2">Mon</div>
                <div class="text-center text-xs font-bold text-gray-400 py-2">Tue</div>
                <div class="text-center text-xs font-bold text-gray-400 py-2">Wed</div>
                <div class="text-center text-xs font-bold text-gray-400 py-2">Thu</div>
                <div class="text-center text-xs font-bold text-gray-400 py-2">Fri</div>
                <div class="text-center text-xs font-bold text-gray-400 py-2">Sat</div>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
            <div class="mt-5 flex items-center gap-4 text-xs text-gray-500">
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 bg-primary-600 rounded-full"></div>Selected</div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 bg-white border-2 border-primary-400 rounded-full"></div>Today</div>
                <div class="flex items-center gap-1.5"><div class="w-1.5 h-1.5 bg-red-500 rounded-full"></div>Fully Booked</div>
            </div>
        </div>

        <!-- Time Slots -->
        <div id="timeSlotsSection" class="bg-white rounded-2xl border border-gray-100 p-6 sm:p-8 hidden">
            <h2 class="flex items-center gap-2 text-lg font-bold text-gray-900 mb-4">
                <div class="w-8 h-8 bg-primary-50 rounded-lg flex items-center justify-center"><i class="fas fa-clock text-primary-600 text-sm"></i></div>
                Select Time
            </h2>
            <div id="timeSlotsList" class="grid grid-cols-2 sm:grid-cols-4 gap-3"></div>
        </div>

        <!-- Submit Button -->
        <button type="submit" id="submitBtn" disabled class="w-full py-4 bg-gray-200 text-gray-400 font-bold rounded-2xl cursor-not-allowed transition-all text-sm">
            <i class="fas fa-calendar-check mr-2"></i>Select date & time to continue
        </button>
    </form>

    <!-- Info -->
    <div class="p-4 bg-blue-50 border border-blue-100 rounded-xl text-sm text-blue-800 flex items-start gap-2">
        <i class="fas fa-info-circle mt-0.5 text-blue-500"></i>
        <span><strong>Note:</strong> Appointments are Mon–Fri, 9 AM – 5 PM. Confirmation will be sent after review.</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentDate=new Date(),selectedDate=null,selectedTime=null,fullyBookedDates=new Set();
const timeSlots={{ time_slots|tojson }};

function changeMonth(d){currentDate.setMonth(currentDate.getMonth()+d);renderCalendar()}
function selectDate(ds,el){if(el.classList.contains('opacity-30'))return;selectedDate=ds;document.getElementById('selectedDate').value=ds;document.querySelectorAll('.calendar-day').forEach(e=>{e.classList.remove('bg-primary-600','text-white','font-bold','shadow-lg','scale-110')});el.classList.add('bg-primary-600','text-white','font-bold','shadow-lg','scale-110');loadTimeSlots(ds)}
function selectTime(v,d,el){if(el.classList.contains('opacity-50'))return;selectedTime=v;document.getElementById('selectedTimeSlot').value=v;document.querySelectorAll('.time-slot').forEach(e=>{e.classList.remove('bg-primary-600','text-white','border-primary-600','font-bold','shadow-lg');e.classList.add('border-gray-200')});el.classList.remove('border-gray-200');el.classList.add('bg-primary-600','text-white','border-primary-600','font-bold','shadow-lg');const b=document.getElementById('submitBtn');b.disabled=false;b.className='w-full py-4 bg-primary-700 text-white font-bold rounded-2xl hover:bg-primary-800 transition-all shadow-lg shadow-primary-700/25 text-sm';b.innerHTML='<i class="fas fa-calendar-check mr-2"></i>Book Appointment'}
async function loadTimeSlots(date){const st=document.querySelector('input[name="service_type"]:checked')?.value;if(!st){Swal.fire({icon:'warning',title:'Select Service',text:'Pick a service type first',customClass:{popup:'rounded-2xl',confirmButton:'bg-primary-600 text-white font-bold py-3 px-6 rounded-xl'},buttonsStyling:false});return}const sec=document.getElementById('timeSlotsSection'),lst=document.getElementById('timeSlotsList');sec.classList.remove('hidden');lst.innerHTML='<div class="col-span-full text-center text-gray-400 py-4 text-sm">Loading...</div>';try{const r=await fetch(`/appointments/check-availability?date=${date}&service=${st}`);const d=await r.json();if(!d.availableSlots||d.availableSlots.length===0){lst.innerHTML='<div class="col-span-full text-center text-amber-600 py-4 text-sm">No slots available</div>';return}lst.innerHTML='';d.availableSlots.forEach(s=>{const sd=timeSlots.find(t=>t.value===s.time);if(!sd)return;const div=document.createElement('div');div.className=`time-slot px-4 py-3 border-2 rounded-xl transition-all text-center text-sm ${!s.available?'bg-gray-50 text-gray-400 opacity-50 cursor-not-allowed border-gray-100':'border-gray-200 hover:border-primary-500 hover:bg-primary-50 cursor-pointer'}`;div.innerHTML=`<div class="font-semibold">${sd.display}</div><div class="text-xs mt-1 ${!s.available?'text-gray-300':'text-gray-500'}">${s.remaining} slots</div>`;if(s.available)div.onclick=()=>selectTime(s.time,sd.display,div);lst.appendChild(div)})}catch(e){lst.innerHTML=`<div class="col-span-full text-center text-red-500 py-4 text-sm">Error: ${e.message}</div>`}}
async function loadCalendar(){const st=document.querySelector('input[name="service_type"]:checked')?.value;if(!st)return;const y=currentDate.getFullYear(),m=currentDate.getMonth()+1;try{const r=await fetch(`/appointments/check-date-availability?year=${y}&month=${m}&service=${st}`);const d=await r.json();fullyBookedDates=new Set(d.fullyBookedDates||[]);renderCalendar()}catch(e){renderCalendar()}}
function renderCalendar(){const y=currentDate.getFullYear(),m=currentDate.getMonth();document.getElementById('currentMonth').textContent=new Date(y,m).toLocaleDateString('en-US',{month:'long',year:'numeric'});const fd=new Date(y,m,1).getDay(),dim=new Date(y,m+1,0).getDate(),td=new Date();td.setHours(0,0,0,0);const g=document.getElementById('calendarGrid');g.innerHTML='';for(let i=0;i<fd;i++)g.innerHTML+='<div></div>';for(let d=1;d<=dim;d++){const dt=new Date(y,m,d);dt.setHours(0,0,0,0);const ds=dt.toISOString().split('T')[0],ip=dt<td,it=dt.getTime()===td.getTime(),fb=fullyBookedDates.has(ds);const div=document.createElement('div');div.className=`calendar-day relative w-12 h-12 flex items-center justify-center rounded-xl transition-all font-medium text-sm ${ip?'text-gray-300 cursor-not-allowed opacity-50':'cursor-pointer hover:scale-110 hover:bg-gray-100 text-gray-900'} ${it?'border-2 border-primary-400 font-bold':''}`;div.textContent=d;if(fb&&!ip){const dot=document.createElement('div');dot.className='absolute bottom-1 w-1.5 h-1.5 bg-red-500 rounded-full';div.appendChild(dot)}if(!ip)div.onclick=()=>selectDate(ds,div);g.appendChild(div)}}
document.addEventListener('DOMContentLoaded',()=>{renderCalendar();const fc=document.getElementById('flash-messages');if(fc){fc.querySelectorAll('[data-category]').forEach(m=>{const c=m.getAttribute('data-category'),msg=m.getAttribute('data-message');Swal.fire({icon:c==='error'?'error':'success',title:c==='error'?'Error':'Success',text:msg,toast:true,position:'top-end',showConfirmButton:false,timer:4000,timerProgressBar:true,customClass:{popup:'rounded-2xl shadow-2xl'}})})}});
</script>
{% endblock %}