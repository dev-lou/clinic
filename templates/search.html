{% extends "admin_base.html" %}
{% set active_page = 'search' %}

{% block title %}Advanced Search{% endblock %}

{% block content %}
<div class="p-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Advanced Search</h1>
        <p class="text-gray-600">Search across all clinic records</p>
    </div>

    <!-- Search Tabs -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
        <div class="border-b border-gray-200">
            <nav class="flex space-x-4 px-6" id="searchTabs">
                <button class="tab-btn active py-4 px-4 font-medium text-sm border-b-2 border-blue-500 text-blue-600" data-tab="global">
                    <i class="fas fa-globe mr-2"></i>Global Search
                </button>
                <button class="tab-btn py-4 px-4 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="patients">
                    <i class="fas fa-users mr-2"></i>Patients
                </button>
                <button class="tab-btn py-4 px-4 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="appointments">
                    <i class="fas fa-calendar-check mr-2"></i>Appointments
                </button>
                <button class="tab-btn py-4 px-4 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="inventory">
                    <i class="fas fa-pills mr-2"></i>Inventory
                </button>
                <button class="tab-btn py-4 px-4 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="visits">
                    <i class="fas fa-heartbeat mr-2"></i>Visits
                </button>
                <button class="tab-btn py-4 px-4 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="reservations">
                    <i class="fas fa-hand-holding-medical mr-2"></i>Reservations
                </button>
            </nav>
        </div>

        <!-- Global Search Tab -->
        <div class="tab-content p-6" id="global-tab">
            <div class="mb-6">
                <input type="text" id="globalSearchInput" placeholder="Search everything... (patient name, medicine, diagnosis, etc.)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button onclick="performGlobalSearch()" class="mt-4 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-search mr-2"></i>Search All
                </button>
            </div>
            <div id="globalResults"></div>
        </div>

        <!-- Patients Search Tab -->
        <div class="tab-content hidden p-6" id="patients-tab">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <input type="text" id="patientName" placeholder="Name" class="px-4 py-3 border border-gray-300 rounded-lg">
                <input type="text" id="patientEmail" placeholder="Email" class="px-4 py-3 border border-gray-300 rounded-lg">
                <input type="text" id="patientStudentId" placeholder="Student ID" class="px-4 py-3 border border-gray-300 rounded-lg">
            </div>
            <button onclick="searchPatients()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                <i class="fas fa-search mr-2"></i>Search Patients
            </button>
            <div id="patientsResults" class="mt-6"></div>
        </div>

        <!-- Appointments Search Tab -->
        <div class="tab-content hidden p-6" id="appointments-tab">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <input type="date" id="apptDateFrom" placeholder="Date From" class="px-4 py-3 border border-gray-300 rounded-lg">
                <input type="date" id="apptDateTo" placeholder="Date To" class="px-4 py-3 border border-gray-300 rounded-lg">
                <select id="apptStatus" class="px-4 py-3 border border-gray-300 rounded-lg">
                    <option value="">All Statuses</option>
                    <option value="Pending">Pending</option>
                    <option value="Confirmed">Confirmed</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                    <option value="No Show">No Show</option>
                </select>
                <select id="apptService" class="px-4 py-3 border border-gray-300 rounded-lg">
                    <option value="">All Services</option>
                    <option value="Consultation">Consultation</option>
                    <option value="Check-up">Check-up</option>
                    <option value="Follow-up">Follow-up</option>
                    <option value="Vaccination">Vaccination</option>
                    <option value="Medical Certificate">Medical Certificate</option>
                    <option value="First Aid">First Aid</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <button onclick="searchAppointments()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                <i class="fas fa-search mr-2"></i>Search Appointments
            </button>
            <div id="appointmentsResults" class="mt-6"></div>
        </div>

        <!-- Inventory Search Tab -->
        <div class="tab-content hidden p-6" id="inventory-tab">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <input type="text" id="medicineName" placeholder="Medicine Name" class="px-4 py-3 border border-gray-300 rounded-lg">
                <label class="flex items-center space-x-2 px-4 py-3">
                    <input type="checkbox" id="lowStock" class="rounded">
                    <span>Low Stock Only</span>
                </label>
                <label class="flex items-center space-x-2 px-4 py-3">
                    <input type="checkbox" id="expiring" class="rounded">
                    <span>Expiring Soon</span>
                </label>
            </div>
            <button onclick="searchInventory()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                <i class="fas fa-search mr-2"></i>Search Inventory
            </button>
            <div id="inventoryResults" class="mt-6"></div>
        </div>

        <!-- Visits Search Tab -->
        <div class="tab-content hidden p-6" id="visits-tab">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <input type="text" id="visitDiagnosis" placeholder="Diagnosis" class="px-4 py-3 border border-gray-300 rounded-lg">
                <input type="date" id="visitDateFrom" placeholder="Date From" class="px-4 py-3 border border-gray-300 rounded-lg">
                <input type="date" id="visitDateTo" placeholder="Date To" class="px-4 py-3 border border-gray-300 rounded-lg">
            </div>
            <button onclick="searchVisits()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                <i class="fas fa-search mr-2"></i>Search Visits
            </button>
            <div id="visitsResults" class="mt-6"></div>
        </div>

        <!-- Reservations Search Tab -->
        <div class="tab-content hidden p-6" id="reservations-tab">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <input type="text" id="reservationMedicine" placeholder="Medicine Name" class="px-4 py-3 border border-gray-300 rounded-lg">
                <select id="reservationStatus" class="px-4 py-3 border border-gray-300 rounded-lg">
                    <option value="">All Statuses</option>
                    <option value="Reserved">Reserved</option>
                    <option value="Ready">Ready</option>
                    <option value="Claimed">Claimed</option>
                    <option value="Cancelled">Cancelled</option>
                    <option value="Expired">Expired</option>
                </select>
                <input type="date" id="reservationDate" class="px-4 py-3 border border-gray-300 rounded-lg">
            </div>
            <button onclick="searchReservations()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                <i class="fas fa-search mr-2"></i>Search Reservations
            </button>
            <div id="reservationsResults" class="mt-6"></div>
        </div>
    </div>
</div>

<script>
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Remove active from all tabs
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active', 'border-blue-500', 'text-blue-600');
                b.classList.add('border-transparent', 'text-gray-500');
            });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            
            // Add active to clicked tab
            btn.classList.add('active', 'border-blue-500', 'text-blue-600');
            btn.classList.remove('border-transparent', 'text-gray-500');
            document.getElementById(btn.dataset.tab + '-tab').classList.remove('hidden');
        });
    });

    // Global Search
    async function performGlobalSearch() {
        const query = document.getElementById('globalSearchInput').value;
        if (!query.trim()) return;
        
        const response = await fetch(`/search/api/global?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        let html = '<div class="space-y-6">';
        
        if (data.patients?.length) {
            html += '<div><h3 class="font-bold text-lg mb-3">Patients</h3><div class="space-y-2">';
            data.patients.forEach(p => {
                html += `<div class="p-4 bg-gray-50 rounded-lg">${p.first_name} ${p.last_name} - ${p.email}</div>`;
            });
            html += '</div></div>';
        }
        
        if (data.appointments?.length) {
            html += '<div><h3 class="font-bold text-lg mb-3">Appointments</h3><div class="space-y-2">';
            data.appointments.forEach(a => {
                html += `<div class="p-4 bg-gray-50 rounded-lg">${a.service_type} - ${a.appointment_date} (${a.status})</div>`;
            });
            html += '</div></div>';
        }
        
        if (data.medicines?.length) {
            html += '<div><h3 class="font-bold text-lg mb-3">Medicines</h3><div class="space-y-2">';
            data.medicines.forEach(m => {
                html += `<div class="p-4 bg-gray-50 rounded-lg">${m.medicine_name} - Stock: ${m.quantity}</div>`;
            });
            html += '</div></div>';
        }
        
        html += '</div>';
        document.getElementById('globalResults').innerHTML = html || '<p class="text-gray-500">No results found</p>';
    }

    // Search Patients
    async function searchPatients() {
        const params = new URLSearchParams({
            name: document.getElementById('patientName').value,
            email: document.getElementById('patientEmail').value,
            student_id: document.getElementById('patientStudentId').value
        });
        
        const response = await fetch(`/search/api/patients?${params}`);
        const data = await response.json();
        
        let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
        data.forEach(patient => {
            html += `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <h4 class="font-bold text-gray-900">${patient.first_name} ${patient.last_name}</h4>
                    <p class="text-sm text-gray-600">${patient.email}</p>
                    <p class="text-sm text-gray-600">Student ID: ${patient.student_id || 'N/A'}</p>
                    <p class="text-sm text-gray-600">Role: <span class="capitalize">${patient.role}</span></p>
                </div>
            `;
        });
        html += '</div>';
        document.getElementById('patientsResults').innerHTML = html || '<p class="text-gray-500">No patients found</p>';
    }

    // Search Appointments
    async function searchAppointments() {
        const params = new URLSearchParams({
            date_from: document.getElementById('apptDateFrom').value,
            date_to: document.getElementById('apptDateTo').value,
            status: document.getElementById('apptStatus').value,
            service: document.getElementById('apptService').value
        });
        
        const response = await fetch(`/search/api/appointments?${params}`);
        const data = await response.json();
        
        let html = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">';
        html += '<thead class="bg-gray-50"><tr>';
        html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>';
        html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Patient</th>';
        html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Service</th>';
        html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>';
        html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
        
        data.forEach(appt => {
            const statusColors = {
                'Pending': 'bg-yellow-100 text-yellow-800',
                'Confirmed': 'bg-blue-100 text-blue-800',
                'Completed': 'bg-green-100 text-green-800',
                'Cancelled': 'bg-red-100 text-red-800',
                'No Show': 'bg-gray-100 text-gray-800'
            };
            html += `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${appt.appointment_date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${appt.student?.first_name || ''} ${appt.student?.last_name || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${appt.service_type}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs rounded-full ${statusColors[appt.status] || ''}">${appt.status}</span></td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        document.getElementById('appointmentsResults').innerHTML = html || '<p class="text-gray-500">No appointments found</p>';
    }

    // Search Inventory
    async function searchInventory() {
        const params = new URLSearchParams({
            medicine_name: document.getElementById('medicineName').value,
            low_stock: document.getElementById('lowStock').checked,
            expiring: document.getElementById('expiring').checked
        });
        
        const response = await fetch(`/search/api/inventory?${params}`);
        const data = await response.json();
        
        let html = '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">';
        data.forEach(item => {
            const isLowStock = item.quantity <= (item.reorder_level || 10);
            html += `
                <div class="bg-white rounded-lg p-4 border ${isLowStock ? 'border-red-300' : 'border-gray-200'}">
                    <h4 class="font-bold text-gray-900">${item.medicine_name}</h4>
                    <p class="text-sm text-gray-600">Quantity: <span class="${isLowStock ? 'text-red-600 font-bold' : ''}">${item.quantity}</span></p>
                    <p class="text-sm text-gray-600">Category: ${item.category}</p>
                    ${item.expiry_date ? `<p class="text-sm text-gray-600">Expires: ${item.expiry_date}</p>` : ''}
                    ${isLowStock ? '<p class="text-xs text-red-600 mt-2"><i class="fas fa-exclamation-triangle mr-1"></i>Low Stock</p>' : ''}
                </div>
            `;
        });
        html += '</div>';
        document.getElementById('inventoryResults').innerHTML = html || '<p class="text-gray-500">No medicines found</p>';
    }

    // Search Visits
    async function searchVisits() {
        const params = new URLSearchParams({
            diagnosis: document.getElementById('visitDiagnosis').value,
            date_from: document.getElementById('visitDateFrom').value,
            date_to: document.getElementById('visitDateTo').value
        });
        
        const response = await fetch(`/search/api/visits?${params}`);
        const data = await response.json();
        
        let html = '<div class="space-y-4">';
        data.forEach(visit => {
            html += `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-gray-900">${visit.student?.first_name || ''} ${visit.student?.last_name || ''}</h4>
                            <p class="text-sm text-gray-600">Date: ${visit.visit_date}</p>
                            <p class="text-sm text-gray-600">Complaint: ${visit.chief_complaint || 'N/A'}</p>
                            <p class="text-sm text-gray-600">Diagnosis: ${visit.diagnosis || 'N/A'}</p>
                        </div>
                        <span class="px-3 py-1 text-xs rounded-full ${visit.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${visit.status}</span>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        document.getElementById('visitsResults').innerHTML = html || '<p class="text-gray-500">No visits found</p>';
    }

    // Search Reservations
    async function searchReservations() {
        const params = new URLSearchParams({
            medicine_name: document.getElementById('reservationMedicine').value,
            status: document.getElementById('reservationStatus').value,
            date: document.getElementById('reservationDate').value
        });
        
        const response = await fetch(`/search/api/reservations?${params}`);
        const data = await response.json();
        
        let html = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">';
        html += '<thead class="bg-gray-50"><tr>';
        html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>';
        html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Patient</th>';
        html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Medicine</th>';
        html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>';
        html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>';
        html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
        
        data.forEach(res => {
            html += `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${res.reserved_at}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${res.student?.first_name || ''} ${res.student?.last_name || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${res.medicine_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${res.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${res.status}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        document.getElementById('reservationsResults').innerHTML = html || '<p class="text-gray-500">No reservations found</p>';
    }
</script>
{% endblock %}
