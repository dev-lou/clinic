<!-- Notification Bell Component - Include this in client navbars -->
<!-- Requires: SweetAlert2 CDN, user must be authenticated -->

{% if current_user.is_authenticated %}
<div class="relative" id="notif-bell-container">
    <button onclick="toggleNotifications()"
        class="relative p-2 text-gray-600 hover:text-primary-700 hover:bg-primary-50 rounded-lg transition-all"
        title="Notifications">
        <i class="fas fa-bell text-lg"></i>
        <span id="notif-badge"
            class="hidden absolute -top-0.5 -right-0.5 w-5 h-5 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center animate-pulse">0</span>
    </button>

    <!-- Notification Dropdown -->
    <div id="notif-dropdown"
        class="hidden absolute right-0 mt-2 w-80 bg-white rounded-2xl shadow-2xl border border-gray-100 z-50 overflow-hidden">
        <div class="px-4 py-3 bg-gradient-to-r from-primary-600 to-primary-700 flex items-center justify-between">
            <h3 class="text-sm font-bold text-white"><i class="fas fa-bell mr-1.5"></i>Notifications</h3>
            <button onclick="markAllRead()"
                class="text-xs text-blue-200 hover:text-white transition-colors font-medium">
                Mark all read
            </button>
        </div>
        <div id="notif-list" class="max-h-80 overflow-y-auto divide-y divide-gray-50">
            <div class="px-4 py-8 text-center text-gray-400 text-sm">
                <i class="fas fa-bell-slash text-2xl mb-2 block opacity-50"></i>
                No notifications
            </div>
        </div>
    </div>
</div>

<script>
    let notifOpen = false;

    // Close dropdown on outside click
    document.addEventListener('click', (e) => {
        const container = document.getElementById('notif-bell-container');
        if (container && !container.contains(e.target)) {
            document.getElementById('notif-dropdown').classList.add('hidden');
            notifOpen = false;
        }
    });

    function toggleNotifications() {
        const dropdown = document.getElementById('notif-dropdown');
        notifOpen = !notifOpen;
        dropdown.classList.toggle('hidden');
        if (notifOpen) loadNotifications();
    }

    function fetchUnreadCount() {
        fetch('/notifications/unread-count')
            .then(r => r.json())
            .then(data => {
                const badge = document.getElementById('notif-badge');
                if (data.count > 0) {
                    badge.textContent = data.count > 9 ? '9+' : data.count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            })
            .catch(() => { });
    }

    function loadNotifications() {
        fetch('/notifications/list')
            .then(r => r.json())
            .then(data => {
                const list = document.getElementById('notif-list');
                if (!data.notifications || data.notifications.length === 0) {
                    list.innerHTML = `<div class="px-4 py-8 text-center text-gray-400 text-sm">
                        <i class="fas fa-bell-slash text-2xl mb-2 block opacity-50"></i>No notifications</div>`;
                    return;
                }

                list.innerHTML = data.notifications.map(n => {
                    const iconMap = {
                        'appointment_update': 'fas fa-calendar-check text-primary-600',
                        'reservation_update': 'fas fa-pills text-emerald-600',
                        'reminder': 'fas fa-clock text-amber-600'
                    };
                    const icon = iconMap[n.type] || 'fas fa-info-circle text-gray-400';
                    const unreadBg = n.is_read ? '' : 'bg-primary-50/50';

                    return `<div class="px-4 py-3 hover:bg-gray-50 transition-colors cursor-pointer ${unreadBg}" 
                                onclick="handleNotifClick(${n.id}, '${n.link || ''}')">
                        <div class="flex gap-3 items-start">
                            <div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center flex-shrink-0 mt-0.5">
                                <i class="${icon} text-sm"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-semibold text-gray-900 ${n.is_read ? 'font-medium' : 'font-bold'}">${n.title}</p>
                                <p class="text-xs text-gray-500 mt-0.5 line-clamp-2">${n.message}</p>
                                <p class="text-[10px] text-gray-400 mt-1">${n.time_ago}</p>
                            </div>
                            ${!n.is_read ? '<div class="w-2 h-2 bg-primary-500 rounded-full flex-shrink-0 mt-2"></div>' : ''}
                        </div>
                    </div>`;
                }).join('');
            })
            .catch(() => { });
    }

    function handleNotifClick(id, link) {
        fetch('/notifications/mark-read', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
            body: JSON.stringify({ id: id })
        }).then(() => {
            fetchUnreadCount();
            if (link) window.location.href = link;
            else loadNotifications();
        });
    }

    function markAllRead() {
        fetch('/notifications/mark-read', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
            body: JSON.stringify({ all: true })
        }).then(() => {
            fetchUnreadCount();
            loadNotifications();
        });
    }

    // Poll for new notifications every 30 seconds
    fetchUnreadCount();
    setInterval(fetchUnreadCount, 30000);
</script>
{% endif %}