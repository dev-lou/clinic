<!-- AI Chatbot Widget â€” ISUFST CareHub -->
<!-- Include this partial before </body> in base templates -->

<style>
    /* Chatbot Floating Button */
    .chatbot-fab {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(37, 99, 235, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: all 0.3s cubic-bezier(.16, 1, .3, 1);
        animation: chatbotIdle 3s infinite ease-in-out;
    }

    @keyframes chatbotIdle {

        0%,
        100% {
            transform: translateY(0) scale(1);
        }

        50% {
            transform: translateY(-5px) scale(1.05);
        }
    }

    .chatbot-fab:hover {
        transform: scale(1.08);
        box-shadow: 0 6px 28px rgba(37, 99, 235, 0.55);
    }

    .chatbot-fab .fab-icon {
        font-size: 26px;
        transition: transform 0.3s ease;
    }

    .chatbot-fab.open .fab-icon {
        transform: rotate(90deg);
    }

    .chatbot-fab.open {
        opacity: 0;
        pointer-events: none;
        transform: scale(0.9);
    }

    /* Chat Window */
    .chatbot-window {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 380px;
        max-width: calc(100vw - 32px);
        height: 520px;
        max-height: calc(100vh - 140px);
        background: white;
        border-radius: 20px;
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.18);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        z-index: 9998;
        opacity: 0;
        transform: translateY(20px) scale(0.95);
        pointer-events: none;
        transition: all 0.3s cubic-bezier(.16, 1, .3, 1);
    }

    .chatbot-window.open {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
    }

    .chatbot-window.maximized {
        top: 16px;
        right: 16px;
        bottom: 16px;
        left: 16px;
        width: auto;
        height: auto;
        max-width: none;
        max-height: none;
        border-radius: 16px;
    }

    /* Header */
    .chatbot-header {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
    }

    .chatbot-header-avatar {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    .chatbot-header-info h3 {
        font-size: 16px;
        font-weight: 700;
        margin: 0;
        font-family: 'Plus Jakarta Sans', 'Inter', sans-serif;
    }

    .chatbot-header-info p {
        font-size: 12px;
        opacity: 0.85;
        margin: 2px 0 0;
    }

    .chatbot-header-actions {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .chatbot-close-btn {
        background: rgba(255, 255, 255, 0.15);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .chatbot-close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .chatbot-control-btn {
        background: rgba(255, 255, 255, 0.15);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .chatbot-control-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    /* Messages Area */
    .chatbot-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        scroll-behavior: smooth;
    }

    .chatbot-messages::-webkit-scrollbar {
        width: 4px;
    }

    .chatbot-messages::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 10px;
    }

    /* Message Bubbles */
    .chat-msg {
        max-width: 85%;
        padding: 10px 14px;
        border-radius: 16px;
        font-size: 14px;
        line-height: 1.5;
        word-wrap: break-word;
    }

    .chat-msg.user {
        align-self: flex-end;
        background: #2563eb;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .chat-msg.bot {
        align-self: flex-start;
        background: #f3f4f6;
        color: #1f2937;
        border-bottom-left-radius: 4px;
    }

    .chat-msg.bot p {
        margin: 0 0 8px;
    }

    .chat-msg.bot p:last-child {
        margin-bottom: 0;
    }

    .chat-msg.bot ul,
    .chat-msg.bot ol {
        margin: 4px 0;
        padding-left: 20px;
    }

    .chat-msg.bot li {
        margin-bottom: 2px;
    }

    .chat-msg.bot strong {
        font-weight: 600;
    }

    .chat-msg.bot code {
        background: #e5e7eb;
        padding: 1px 4px;
        border-radius: 4px;
        font-size: 13px;
    }

    /* Typing Indicator */
    .chat-typing {
        align-self: flex-start;
        display: flex;
        gap: 4px;
        padding: 12px 16px;
        background: #f3f4f6;
        border-radius: 16px;
        border-bottom-left-radius: 4px;
    }

    .chat-typing span {
        width: 8px;
        height: 8px;
        background: #9ca3af;
        border-radius: 50%;
        animation: typingBounce 1.4s infinite ease-in-out;
    }

    .chat-typing span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .chat-typing span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typingBounce {

        0%,
        80%,
        100% {
            transform: translateY(0);
        }

        40% {
            transform: translateY(-6px);
        }
    }

    /* Welcome Message */
    .chatbot-welcome {
        text-align: center;
        padding: 24px 16px;
        color: #6b7280;
    }

    .chatbot-welcome .welcome-icon {
        font-size: 40px;
        margin-bottom: 12px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .chatbot-welcome h4 {
        color: #1f2937;
        font-size: 16px;
        font-weight: 600;
        margin: 0 0 8px;
    }

    .chatbot-welcome p {
        font-size: 13px;
        margin: 0 0 16px;
        line-height: 1.5;
    }

    .chatbot-suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }

    .chatbot-suggestion-btn {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        color: #2563eb;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .chatbot-suggestion-btn:hover {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
    }

    /* Input Area */
    .chatbot-input-area {
        padding: 12px 16px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        gap: 8px;
        align-items: flex-end;
        flex-shrink: 0;
        background: white;
    }

    .chatbot-input {
        flex: 1;
        border: 1.5px solid #e5e7eb;
        border-radius: 20px;
        padding: 10px 16px;
        font-size: 14px;
        outline: none;
        resize: none;
        max-height: 80px;
        line-height: 1.4;
        transition: border-color 0.2s;
        font-family: 'Inter', sans-serif;
    }

    .chatbot-input:focus {
        border-color: #2563eb;
    }

    .chatbot-input::placeholder {
        color: #9ca3af;
    }

    .chatbot-send-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #2563eb;
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        flex-shrink: 0;
    }

    .chatbot-send-btn:hover {
        background: #1d4ed8;
    }

    .chatbot-send-btn:disabled {
        background: #93c5fd;
        cursor: not-allowed;
    }

    /* Disclaimer Footer */
    .chatbot-disclaimer {
        text-align: center;
        font-size: 10px;
        color: #9ca3af;
        padding: 0 16px 8px;
        flex-shrink: 0;
    }

    /* Mobile adjustments */
    @media (max-width: 440px) {
        .chatbot-window {
            right: 8px;
            bottom: 8px;
            width: calc(100vw - 16px);
            height: calc(100vh - 120px);
            border-radius: 16px;
        }

        .chatbot-fab {
            right: 16px;
            bottom: 16px;
            width: 54px;
            height: 54px;
        }
    }
</style>

<!-- Floating Action Button -->
<button id="chatbotFab" class="chatbot-fab" onclick="openChatbot()" title="Chat with CareHub AI">
    <span class="fab-icon">
        <!-- Robot Head SVG -->
        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="10" rx="2" />
            <circle cx="12" cy="5" r="2" />
            <path d="M12 7v4" />
            <line x1="8" y1="16" x2="8" y2="16" />
            <line x1="16" y1="16" x2="16" y2="16" />
        </svg>
    </span>
</button>

<!-- Chat Window -->
<div id="chatbotWindow" class="chatbot-window">
    <!-- Header -->
    <div class="chatbot-header">
        <div class="chatbot-header-avatar">
            <!-- Professional Robot SVG -->
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="10" rx="2" />
                <circle cx="12" cy="5" r="2" />
                <path d="M12 7v4" />
                <line x1="8" y1="16" x2="8" y2="16" />
                <line x1="16" y1="16" x2="16" y2="16" />
            </svg>
        </div>
        <div class="chatbot-header-info">
            <h3>CareHub AI</h3>
            <p>Health Assistant</p>
        </div>
        <div class="chatbot-header-actions">
            <button class="chatbot-control-btn" onclick="toggleMinimizeChatbot()" title="Restore">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 12h12"></path>
                </svg>
            </button>
            <button class="chatbot-control-btn" onclick="toggleMaximizeChatbot()" title="Maximize">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h16v16H4z"></path>
                </svg>
            </button>
            <button class="chatbot-close-btn" onclick="closeChatbot()" title="Close">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Messages -->
    <div id="chatbotMessages" class="chatbot-messages">
        <!-- Welcome screen -->
        <div id="chatbotWelcome" class="chatbot-welcome">
            <div class="welcome-icon">
                <!-- Robot AI Bot SVG -->
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="1.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="10" rx="2" />
                    <circle cx="12" cy="5" r="2" />
                    <path d="M12 7v4" />
                    <line x1="8" y1="16" x2="8" y2="16" />
                    <line x1="16" y1="16" x2="16" y2="16" />
                </svg>
            </div>
            <h4>Hi {% if current_user.is_authenticated %}{{ current_user.first_name }}{% else %}there{% endif %}! ğŸ‘‹
            </h4>
            <p>I'm CareHub AI, your health assistant. {% if current_user.is_authenticated %}Ask me about symptoms, first
                aid, wellness tips, or clinic services.{% else %}Please <a href="{{ url_for('auth.login') }}"
                    style="color: #2563eb; font-weight: 600;">log in</a> to start chatting.{% endif %}</p>
            {% if current_user.is_authenticated %}
            <div class="chatbot-suggestions">
                <button class="chatbot-suggestion-btn"
                    onclick="sendSuggestion('I have a headache, what should I do?')">ğŸ¤• Headache help</button>
                <button class="chatbot-suggestion-btn"
                    onclick="sendSuggestion('What services does the clinic offer?')">ğŸ¥ Clinic services</button>
                <button class="chatbot-suggestion-btn" onclick="sendSuggestion('How do I book an appointment?')">ğŸ“… Book
                    appointment</button>
                <button class="chatbot-suggestion-btn"
                    onclick="sendSuggestion('I feel sick, should I go to the clinic?')">ğŸ¤’ Feeling sick</button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Input -->
    <div class="chatbot-input-area">
        <textarea id="chatbotInput" class="chatbot-input"
            placeholder="{% if current_user.is_authenticated %}Ask about symptoms, health tips...{% else %}Please log in to chat{% endif %}"
            rows="1" onkeydown="handleChatKeydown(event)" oninput="autoResizeInput(this)" {% if not
            current_user.is_authenticated %}disabled{% endif %}></textarea>
        <button id="chatbotSendBtn" class="chatbot-send-btn" onclick="sendChatMessage()" title="Send" {% if not
            current_user.is_authenticated %}disabled{% endif %}>
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
            </svg>
        </button>
    </div>
    <div class="chatbot-disclaimer">AI can make mistakes. For medical emergencies, call for help immediately.</div>
</div>

<script>
    // â”€â”€â”€ Chatbot State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let chatbotOpen = false;
    let chatbotMaximized = false;

    function openChatbot() {
        if (chatbotOpen) return;
        chatbotOpen = true;
        document.getElementById('chatbotWindow').classList.add('open');
        document.getElementById('chatbotFab').classList.add('open');
        setTimeout(() => document.getElementById('chatbotInput').focus(), 300);
    }

    function closeChatbot() {
        chatbotOpen = false;
        document.getElementById('chatbotWindow').classList.remove('open');
        document.getElementById('chatbotFab').classList.remove('open');
    }

    function toggleMinimizeChatbot() {
        const win = document.getElementById('chatbotWindow');
        chatbotMaximized = false;
        win.classList.remove('maximized');
        win.classList.remove('minimized');
    }

    function toggleMaximizeChatbot() {
        const win = document.getElementById('chatbotWindow');
        chatbotMaximized = !chatbotMaximized;
        if (chatbotMaximized) {
            win.classList.remove('minimized');
        }
        win.classList.toggle('maximized', chatbotMaximized);
    }

    // â”€â”€â”€ Get CSRF token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getChatbotCSRF() {
        const meta = document.querySelector('meta[name="csrf-token"]');
        return meta ? meta.getAttribute('content') : '';
    }

    // â”€â”€â”€ Send Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function sendChatMessage() {
        const input = document.getElementById('chatbotInput');
        if (input.disabled) {
            return; // Not logged in
        }
        const msg = input.value.trim();
        if (!msg) return;

        // Hide welcome screen
        const welcome = document.getElementById('chatbotWelcome');
        if (welcome) welcome.style.display = 'none';

        // Add user bubble
        appendMessage('user', msg);
        input.value = '';
        input.style.height = 'auto';

        // Show typing indicator
        showTyping();

        // Disable send button
        const sendBtn = document.getElementById('chatbotSendBtn');
        sendBtn.disabled = true;

        try {
            const csrfToken = getChatbotCSRF();
            console.log('[CareHub AI] Sending message, CSRF present:', !!csrfToken);

            const resp = await fetch('/chatbot/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({ message: msg }),
            });

            console.log('[CareHub AI] Response status:', resp.status);

            if (!resp.ok && resp.status === 302) {
                hideTyping();
                appendMessage('bot', 'âš ï¸ Session expired. Please refresh the page and log in again.');
                return;
            }

            const text = await resp.text();
            let data;
            try {
                data = JSON.parse(text);
            } catch (parseErr) {
                console.error('[CareHub AI] Non-JSON response:', text.substring(0, 200));
                hideTyping();
                appendMessage('bot', 'âš ï¸ Unexpected response from server. Please refresh the page.');
                return;
            }

            hideTyping();

            if (data.error) {
                appendMessage('bot', 'âš ï¸ ' + data.error);
            } else {
                appendMessage('bot', formatMarkdown(data.reply));
            }
        } catch (err) {
            console.error('[CareHub AI] Fetch error:', err);
            hideTyping();
            appendMessage('bot', "Sorry, I couldn't connect. Please try again later. ğŸ¥");
        }

        sendBtn.disabled = false;
        input.focus();
    }

    function sendSuggestion(text) {
        document.getElementById('chatbotInput').value = text;
        sendChatMessage();
    }

    // â”€â”€â”€ Message Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function appendMessage(role, content) {
        const container = document.getElementById('chatbotMessages');
        const div = document.createElement('div');
        div.className = 'chat-msg ' + role;
        if (role === 'bot') {
            div.innerHTML = content;
        } else {
            div.textContent = content;
        }
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function formatMarkdown(text) {
        // Basic markdown to HTML
        let html = text
            // Bold
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            // Italic
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            // Inline code
            .replace(/`(.+?)`/g, '<code>$1</code>')
            // Unordered list items
            .replace(/^[\-\*]\s+(.+)$/gm, '<li>$1</li>')
            // Numbered list items
            .replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');

        // Wrap consecutive <li> in <ul>
        html = html.replace(/((?:<li>.*?<\/li>\s*)+)/g, '<ul>$1</ul>');

        // Paragraphs (double newline)
        html = html.split(/\n{2,}/).map(p => {
            p = p.trim();
            if (!p) return '';
            if (p.startsWith('<ul>') || p.startsWith('<ol>')) return p;
            return '<p>' + p.replace(/\n/g, '<br>') + '</p>';
        }).join('');

        return html || text;
    }

    // â”€â”€â”€ Typing Indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showTyping() {
        hideTyping();
        const container = document.getElementById('chatbotMessages');
        const typing = document.createElement('div');
        typing.id = 'chatbotTyping';
        typing.className = 'chat-typing';
        typing.innerHTML = '<span></span><span></span><span></span>';
        container.appendChild(typing);
        container.scrollTop = container.scrollHeight;
    }

    function hideTyping() {
        const t = document.getElementById('chatbotTyping');
        if (t) t.remove();
    }

    // â”€â”€â”€ Input Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function handleChatKeydown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
        }
    }

    function autoResizeInput(el) {
        el.style.height = 'auto';
        el.style.height = Math.min(el.scrollHeight, 80) + 'px';
    }
</script>