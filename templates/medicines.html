{% extends "student_base.html" %}
{% block title %}Medicine Pharmacy &mdash; ISUFST CareHub{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
.med-card{transition:all .4s cubic-bezier(.16,1,.3,1)}
.med-card:hover{transform:translateY(-6px);box-shadow:0 25px 50px -12px rgba(0,0,0,.1)}
</style>
{% endblock %}

{% block content %}
<div class="space-y-8 fade-in">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
        <div>
            <span class="inline-flex items-center px-3.5 py-1.5 bg-emerald-50 border border-emerald-100 text-emerald-700 text-xs font-bold rounded-full mb-3">
                <i class="fas fa-pills mr-1.5"></i>Free for Students
            </span>
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900">Medicine Pharmacy</h1>
            <p class="text-gray-500 mt-1.5 text-sm">Reserve medicines for free. Pick up Mon–Fri, 9 AM – 5 PM.</p>
        </div>
        <div class="flex-shrink-0 inline-flex items-center gap-3 px-5 py-3.5 bg-white rounded-2xl border border-gray-100 shadow-sm">
            <div class="w-10 h-10 bg-emerald-50 rounded-xl flex items-center justify-center"><i class="fas fa-box-open text-emerald-600"></i></div>
            <div>
                <p class="text-2xl font-extrabold text-gray-900">{{ medicines|length }}</p>
                <p class="text-[10px] text-gray-400 uppercase font-bold">Available</p>
            </div>
        </div>
    </div>

    <!-- Grid -->
    {% if medicines %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
        {% for medicine in medicines %}
        <div class="med-card bg-white rounded-2xl border border-gray-100 overflow-hidden">
            <div class="h-1.5 bg-gradient-to-r {% if medicine.is_expiring_soon() %}from-red-500 to-orange-500{% else %}from-emerald-500 to-teal-500{% endif %}"></div>
            <div class="p-5">
                <div class="flex items-start justify-between mb-4">
                    <div class="w-11 h-11 bg-gradient-to-br from-primary-600 to-primary-700 rounded-xl flex items-center justify-center shadow-md shadow-primary-600/20">
                        <i class="fas fa-capsules text-white text-sm"></i>
                    </div>
                    {% if medicine.is_expiring_soon() %}
                    <span class="px-2.5 py-1 bg-red-50 text-red-600 rounded-lg text-[10px] font-bold flex items-center">
                        <span class="w-1.5 h-1.5 bg-red-500 rounded-full mr-1.5 pulse"></span>Expiring
                    </span>
                    {% else %}
                    <span class="px-2.5 py-1 bg-emerald-50 text-emerald-600 rounded-lg text-[10px] font-bold">In Stock</span>
                    {% endif %}
                </div>

                <h3 class="text-base font-bold text-gray-900 mb-3 truncate">{{ medicine.name }}</h3>

                <div class="space-y-1.5 text-xs text-gray-500 mb-4">
                    <div class="flex items-center justify-between">
                        <span><i class="fas fa-warehouse w-4 mr-1 text-gray-400"></i>Stock</span>
                        <span class="font-bold text-gray-900">{{ medicine.quantity }}</span>
                    </div>
                    {% if medicine.batch_number %}
                    <div class="flex items-center justify-between">
                        <span><i class="fas fa-barcode w-4 mr-1 text-gray-400"></i>Batch</span>
                        <span class="font-mono text-gray-600">{{ medicine.batch_number }}</span>
                    </div>
                    {% endif %}
                    {% if medicine.expiry_date %}
                    <div class="flex items-center justify-between">
                        <span><i class="fas fa-calendar w-4 mr-1 text-gray-400"></i>Expires</span>
                        <span class="text-gray-600">{{ medicine.expiry_date.strftime('%b %d, %Y') }}</span>
                    </div>
                    {% endif %}
                </div>

                {% if medicine.quantity > 0 %}
                <form method="POST" action="{{ url_for('reservations.reserve_medicine', medicine_id=medicine.id) }}" onsubmit="return confirmReservation(event, '{{ medicine.name }}');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="flex gap-2">
                        <input type="number" name="quantity" min="1" max="{{ medicine.quantity }}" value="1" class="w-16 px-2.5 py-2 border border-gray-200 rounded-xl text-sm focus:border-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-600/10 text-center">
                        <button type="submit" class="flex-1 py-2 bg-primary-700 text-white text-xs font-bold rounded-xl hover:bg-primary-800 transition shadow-sm">
                            <i class="fas fa-hand-holding-heart mr-1"></i>Reserve
                        </button>
                    </div>
                </form>
                {% else %}
                <button disabled class="w-full py-2 bg-gray-100 text-gray-400 text-xs font-medium rounded-xl cursor-not-allowed">Out of Stock</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-20">
        <div class="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><i class="fas fa-pills text-gray-300 text-2xl"></i></div>
        <h3 class="text-lg font-bold text-gray-900 mb-1">No medicines available</h3>
        <p class="text-gray-400 text-sm">Check back later</p>
    </div>
    {% endif %}

    <!-- How It Works -->
    <div class="bg-white rounded-2xl border border-gray-100 p-6 sm:p-8">
        <h2 class="text-lg font-bold text-gray-900 mb-6 text-center">How It Works</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
            <div class="text-center">
                <div class="w-12 h-12 bg-primary-50 rounded-xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-search text-primary-600"></i></div>
                <h3 class="font-bold text-gray-900 text-sm mb-1">1. Browse</h3>
                <p class="text-xs text-gray-500">Find the medicine you need</p>
            </div>
            <div class="text-center">
                <div class="w-12 h-12 bg-emerald-50 rounded-xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-hand-pointer text-emerald-600"></i></div>
                <h3 class="font-bold text-gray-900 text-sm mb-1">2. Reserve</h3>
                <p class="text-xs text-gray-500">Select quantity and reserve online</p>
            </div>
            <div class="text-center">
                <div class="w-12 h-12 bg-amber-50 rounded-xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-box-open text-amber-600"></i></div>
                <h3 class="font-bold text-gray-900 text-sm mb-1">3. Pick Up</h3>
                <p class="text-xs text-gray-500">Collect at the clinic anytime</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function confirmReservation(e,name){e.preventDefault();const f=e.target;const qty=f.querySelector('input[name="quantity"]').value;Swal.fire({title:'Reserve Medicine?',html:`<p class="text-gray-600">Reserve <strong>${qty}</strong> unit(s) of <strong>${name}</strong>?</p>`,icon:'question',showCancelButton:true,confirmButtonText:'Yes, reserve',cancelButtonText:'Cancel',customClass:{popup:'rounded-2xl',confirmButton:'bg-primary-600 text-white font-bold py-3 px-6 rounded-xl ml-2',cancelButton:'bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-xl mr-2'},buttonsStyling:false,reverseButtons:true}).then(r=>{if(r.isConfirmed)f.submit()});return false}
document.addEventListener('DOMContentLoaded',()=>{const fc=document.getElementById('flash-messages');if(fc){fc.querySelectorAll('[data-category]').forEach(m=>{const c=m.getAttribute('data-category'),msg=m.getAttribute('data-message');Swal.fire({icon:c==='error'?'error':'success',text:msg,toast:true,position:'top-end',showConfirmButton:false,timer:4000,timerProgressBar:true,customClass:{popup:'rounded-2xl shadow-2xl'}})})}});
</script>
{% endblock %}