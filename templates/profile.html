{% extends "student_base.html" %}
{% block title %}My Profile &mdash; ISUFST CareHub{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}

{% block content %}
<div class="space-y-8 fade-in max-w-4xl mx-auto">
    <!-- Header -->
    <div class="relative bg-gradient-to-br from-violet-800 via-violet-700 to-indigo-800 rounded-3xl p-8 sm:p-10 overflow-hidden">
        <div class="absolute top-0 right-0 w-72 h-72 bg-white/[0.04] rounded-full -translate-y-1/3 translate-x-1/4"></div>
        <div class="relative z-10 flex items-center gap-5">
            <div class="w-16 h-16 bg-white/10 rounded-2xl flex items-center justify-center border border-white/10">
                <span class="text-2xl font-bold text-white">{{ current_user.first_name[0] }}{{ current_user.last_name[0] }}</span>
            </div>
            <div>
                <h1 class="text-3xl font-extrabold text-white mb-0.5">My Profile</h1>
                <p class="text-violet-200/50 text-sm">Manage your account settings</p>
            </div>
        </div>
    </div>

    <!-- Personal Info Form -->
    <div class="bg-white rounded-2xl border border-gray-100 p-6 sm:p-8">
        <h2 class="flex items-center gap-2 text-lg font-bold text-gray-900 mb-6">
            <div class="w-8 h-8 bg-primary-50 rounded-lg flex items-center justify-center"><i class="fas fa-user-circle text-primary-600 text-sm"></i></div>
            Personal Information
        </h2>
        <form method="POST" id="infoForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="update_info">

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">First Name</label>
                    <input type="text" name="first_name" value="{{ current_user.first_name }}" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary-600 focus:ring-2 focus:ring-primary-600/10 outline-none transition text-sm">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Last Name</label>
                    <input type="text" name="last_name" value="{{ current_user.last_name }}" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary-600 focus:ring-2 focus:ring-primary-600/10 outline-none transition text-sm">
                </div>
            </div>

            <div class="mb-5">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                <input type="email" name="email" value="{{ current_user.email }}" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary-600 focus:ring-2 focus:ring-primary-600/10 outline-none transition text-sm">
            </div>

            {% if current_user.role == 'student' and current_user.student_profile %}
            <div class="border-t border-gray-100 pt-6 mb-5">
                <h3 class="text-sm font-bold text-gray-900 mb-4">Student Information</h3>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Student ID</label>
                    <input type="text" value="{{ current_user.student_profile.student_id_number }}" readonly class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 text-gray-500 cursor-not-allowed text-sm">
                    <p class="text-xs text-gray-400 mt-1">Student ID cannot be changed</p>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Contact Number</label>
                        <input type="text" name="contact_number" value="{{ current_user.student_profile.contact_number or '' }}" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary-600 focus:ring-2 focus:ring-primary-600/10 outline-none transition text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Blood Type</label>
                        <select name="blood_type" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary-600 focus:ring-2 focus:ring-primary-600/10 outline-none transition text-sm">
                            <option value="">Select...</option>
                            {% for bt in ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'] %}
                            <option value="{{ bt }}" {% if current_user.student_profile.blood_type == bt %}selected{% endif %}>{{ bt }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Course</label>
                        <input type="text" name="course" value="{{ current_user.student_profile.course or '' }}" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary-600 focus:ring-2 focus:ring-primary-600/10 outline-none transition text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Year Level</label>
                        <select name="year_level" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary-600 focus:ring-2 focus:ring-primary-600/10 outline-none transition text-sm">
                            <option value="">Select...</option>
                            {% for year in [1, 2, 3, 4, 5] %}
                            <option value="{{ year }}" {% if current_user.student_profile.year_level == year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Allergies</label>
                    <textarea name="allergies" rows="2" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary-600 focus:ring-2 focus:ring-primary-600/10 outline-none transition text-sm">{{ current_user.student_profile.allergies or '' }}</textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Medical Conditions</label>
                    <textarea name="medical_conditions" rows="2" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary-600 focus:ring-2 focus:ring-primary-600/10 outline-none transition text-sm">{{ current_user.student_profile.medical_conditions or '' }}</textarea>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Emergency Contact Name</label>
                        <input type="text" name="emergency_contact_name" value="{{ current_user.student_profile.emergency_contact_name or '' }}" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary-600 focus:ring-2 focus:ring-primary-600/10 outline-none transition text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Emergency Contact Number</label>
                        <input type="text" name="emergency_contact_number" value="{{ current_user.student_profile.emergency_contact_number or '' }}" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary-600 focus:ring-2 focus:ring-primary-600/10 outline-none transition text-sm">
                    </div>
                </div>
            </div>
            {% endif %}

            <button type="submit" class="w-full py-3.5 bg-primary-700 text-white font-bold rounded-xl hover:bg-primary-800 transition-all shadow-sm text-sm">
                <i class="fas fa-save mr-2"></i>Save Changes
            </button>
        </form>
    </div>

    <!-- Digital Signature -->
    <div class="bg-white rounded-2xl border border-gray-100 p-6 sm:p-8">
        <h2 class="flex items-center gap-2 text-lg font-bold text-gray-900 mb-2">
            <div class="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center"><i class="fas fa-signature text-blue-600 text-sm"></i></div>
            Digital Signature
        </h2>
        <p class="text-sm text-gray-600 mb-4">Draw your signature below. This will be used on health certificates and official documents.</p>

        {% if current_user.signature_data %}
        <!-- Saved Signature Display -->
        <div id="savedSignatureView" class="mb-4">
            <div class="p-4 bg-gray-50 rounded-xl border border-gray-200 mb-3">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Current Signature:</p>
                <img src="{{ current_user.signature_data }}" alt="Current Signature" class="border border-gray-300 rounded-lg bg-white max-w-md">
            </div>
            <button type="button" id="updateSignatureBtn" class="w-full py-2.5 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition text-sm">
                <i class="fas fa-edit mr-2"></i>Update Signature
            </button>
        </div>
        {% endif %}

        <!-- Signature Canvas (hidden if signature exists) -->
        <div id="signatureCanvasContainer" class="border-2 border-dashed border-gray-300 rounded-xl p-4 bg-gray-50 {% if current_user.signature_data %}hidden{% endif %}">
            <canvas id="signatureCanvas" class="w-full bg-white border border-gray-200 rounded-lg cursor-crosshair" height="200" style="touch-action: none;"></canvas>
            <div class="flex gap-2 mt-4">
                <button type="button" id="clearSignature" class="flex-1 py-2.5 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition text-sm">
                    <i class="fas fa-eraser mr-2"></i>Clear
                </button>
                <button type="button" id="saveSignature" class="flex-1 py-2.5 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition text-sm">
                    <i class="fas fa-save mr-2"></i>Save Signature
                </button>
                {% if current_user.signature_data %}
                <button type="button" id="cancelUpdateBtn" class="flex-1 py-2.5 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition text-sm">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Change Password -->
    <div class="bg-white rounded-2xl border border-gray-100 p-6 sm:p-8">
        <h2 class="flex items-center gap-2 text-lg font-bold text-gray-900 mb-6">
            <div class="w-8 h-8 bg-red-50 rounded-lg flex items-center justify-center"><i class="fas fa-lock text-red-500 text-sm"></i></div>
            Change Password
        </h2>
        <form method="POST" id="passwordForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="change_password">

            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Current Password</label>
                <input type="password" name="current_password" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary-600 focus:ring-2 focus:ring-primary-600/10 outline-none transition text-sm">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">New Password</label>
                <input type="password" name="new_password" required minlength="6" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary-600 focus:ring-2 focus:ring-primary-600/10 outline-none transition text-sm">
            </div>
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Confirm New Password</label>
                <input type="password" name="confirm_password" required minlength="6" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary-600 focus:ring-2 focus:ring-primary-600/10 outline-none transition text-sm">
            </div>

            <button type="submit" class="w-full py-3.5 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition-all shadow-sm text-sm">
                <i class="fas fa-key mr-2"></i>Update Password
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Signature Canvas Setup
const canvas = document.getElementById('signatureCanvas');
const ctx = canvas.getContext('2d');
let isDrawing = false;
let lastX = 0;
let lastY = 0;

// Set canvas resolution
function resizeCanvas() {
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = 200;
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// Drawing functions
function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    [lastX, lastY] = [e.clientX - rect.left, e.clientY - rect.top];
}

function draw(e) {
    if (!isDrawing) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    [lastX, lastY] = [x, y];
}

function stopDrawing() {
    isDrawing = false;
}

// Touch support
function getTouchPos(e) {
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    return {
        x: touch.clientX - rect.left,
        y: touch.clientY - rect.top
    };
}

canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    isDrawing = true;
    const pos = getTouchPos(e);
    [lastX, lastY] = [pos.x, pos.y];
});

canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (!isDrawing) return;
    const pos = getTouchPos(e);
    
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    [lastX, lastY] = [pos.x, pos.y];
});

canvas.addEventListener('touchend', () => {
    isDrawing = false;
});

// Mouse events
canvas.addEventListener('mousedown', startDrawing);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', stopDrawing);
canvas.addEventListener('mouseout', stopDrawing);

// Clear signature
document.getElementById('clearSignature').addEventListener('click', () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
});

// Save signature
document.getElementById('saveSignature').addEventListener('click', async () => {
    // Check if canvas is empty
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const isEmpty = !imageData.data.some(channel => channel !== 0);
    
    if (isEmpty) {
        Swal.fire({
            icon: 'warning',
            title: 'Empty Signature',
            text: 'Please draw your signature first',
            customClass: {popup: 'rounded-2xl'}
        });
        return;
    }
    
    const signatureData = canvas.toDataURL('image/png');
    
    try {
        const response = await fetch('{{ url_for("auth.profile") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                action: 'save_signature',
                signature_data: signatureData
            })
        });
        
        if (!response.ok) {
            throw new Error('Server error: ' + response.status);
        }
        
        const result = await response.json();
        
        if (result.success) {
            Swal.fire({
                icon: 'success',
                title: 'Saved!',
                text: result.message,
                customClass: {popup: 'rounded-2xl'}
            }).then(() => {
                location.reload();
            });
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message || 'Failed to save signature',
            customClass: {popup: 'rounded-2xl'}
        });
    }
});

// Update Signature button - show canvas, hide saved signature view
const updateSignatureBtn = document.getElementById('updateSignatureBtn');
if (updateSignatureBtn) {
    updateSignatureBtn.addEventListener('click', () => {
        document.getElementById('savedSignatureView').classList.add('hidden');
        document.getElementById('signatureCanvasContainer').classList.remove('hidden');
    });
}

// Cancel Update button - hide canvas, show saved signature view
const cancelUpdateBtn = document.getElementById('cancelUpdateBtn');
if (cancelUpdateBtn) {
    cancelUpdateBtn.addEventListener('click', () => {
        // Clear the canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // Toggle views
        document.getElementById('signatureCanvasContainer').classList.add('hidden');
        document.getElementById('savedSignatureView').classList.remove('hidden');
    });
}

// Flash messages and form confirmations
document.addEventListener('DOMContentLoaded',()=>{const fc=document.getElementById('flash-messages');if(fc){fc.querySelectorAll('[data-category]').forEach(m=>{const c=m.getAttribute('data-category'),msg=m.getAttribute('data-message');Swal.fire({icon:c==='error'?'error':'success',text:msg,toast:true,position:'top-end',showConfirmButton:false,timer:4000,timerProgressBar:true,customClass:{popup:'rounded-2xl shadow-2xl'}})})}});
document.getElementById('infoForm').addEventListener('submit',function(e){e.preventDefault();Swal.fire({title:'Update Profile?',text:'Save changes?',icon:'question',showCancelButton:true,confirmButtonText:'Yes, update',cancelButtonText:'Cancel',customClass:{popup:'rounded-2xl',confirmButton:'bg-primary-600 text-white font-bold py-3 px-6 rounded-xl ml-2',cancelButton:'bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-xl mr-2'},buttonsStyling:false,reverseButtons:true}).then(r=>{if(r.isConfirmed)this.submit()})});
document.getElementById('passwordForm').addEventListener('submit',function(e){e.preventDefault();const np=this.querySelector('[name="new_password"]').value,cp=this.querySelector('[name="confirm_password"]').value;if(np!==cp){Swal.fire({icon:'error',title:'Error',text:'Passwords do not match!',customClass:{popup:'rounded-2xl'}});return}Swal.fire({title:'Change Password?',icon:'warning',showCancelButton:true,confirmButtonText:'Yes',cancelButtonText:'Cancel',customClass:{popup:'rounded-2xl',confirmButton:'bg-red-600 text-white font-bold py-3 px-6 rounded-xl ml-2',cancelButton:'bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-xl mr-2'},buttonsStyling:false,reverseButtons:true}).then(r=>{if(r.isConfirmed)this.submit()})});
</script>
{% endblock %}