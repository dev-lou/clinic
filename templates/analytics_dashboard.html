{% extends "admin_base.html" %}
{% set active_page = 'analytics' %}

{% block title %}Analytics Dashboard{% endblock %}

{% block content %}
<div class="space-y-6 fade-in">
    <!-- Header -->
    <div class="relative bg-gradient-to-br from-violet-800 via-violet-700 to-indigo-800 rounded-3xl p-8 sm:p-10 overflow-hidden">
        <div class="absolute top-0 right-0 w-72 h-72 bg-white/[0.04] rounded-full -translate-y-1/3 translate-x-1/4"></div>
        <div class="relative z-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-white mb-1">Analytics Dashboard</h1>
            <p class="text-violet-200/50 text-sm">Comprehensive clinic performance metrics and insights</p>
        </div>
    </div>

    <!-- Quick Stats -->
    <div id="statsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white rounded-2xl border border-gray-100 p-5 animate-pulse"><div class="h-20 bg-gray-100 rounded-xl"></div></div>
        <div class="bg-white rounded-2xl border border-gray-100 p-5 animate-pulse"><div class="h-20 bg-gray-100 rounded-xl"></div></div>
        <div class="bg-white rounded-2xl border border-gray-100 p-5 animate-pulse"><div class="h-20 bg-gray-100 rounded-xl"></div></div>
        <div class="bg-white rounded-2xl border border-gray-100 p-5 animate-pulse"><div class="h-20 bg-gray-100 rounded-xl"></div></div>
    </div>

    <!-- Charts Row 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
        <div class="bg-white rounded-2xl border border-gray-100 p-6">
            <h3 class="flex items-center gap-2 text-sm font-bold text-gray-900 mb-4">
                <div class="w-7 h-7 bg-blue-50 rounded-lg flex items-center justify-center"><i class="fas fa-chart-line text-blue-500 text-xs"></i></div>
                Appointments Trend
            </h3>
            <div style="position:relative;height:250px"><canvas id="appointmentsTrendChart"></canvas></div>
        </div>

        <div id="serviceChartContainer" class="bg-white rounded-2xl border border-gray-100 p-6">
            <h3 class="flex items-center gap-2 text-sm font-bold text-gray-900 mb-4">
                <div class="w-7 h-7 bg-emerald-50 rounded-lg flex items-center justify-center"><i class="fas fa-chart-pie text-emerald-500 text-xs"></i></div>
                Service Distribution
            </h3>
            <div style="position:relative;height:250px"><canvas id="serviceDistributionChart"></canvas></div>
        </div>

        <div class="bg-white rounded-2xl border border-gray-100 p-6">
            <h3 class="flex items-center gap-2 text-sm font-bold text-gray-900 mb-4">
                <div class="w-7 h-7 bg-violet-50 rounded-lg flex items-center justify-center"><i class="fas fa-clock text-violet-500 text-xs"></i></div>
                Peak Hours
            </h3>
            <div style="position:relative;height:250px"><canvas id="peakHoursChart"></canvas></div>
        </div>

        <div id="doctorChartContainer" class="bg-white rounded-2xl border border-gray-100 p-6">
            <h3 class="flex items-center gap-2 text-sm font-bold text-gray-900 mb-4">
                <div class="w-7 h-7 bg-indigo-50 rounded-lg flex items-center justify-center"><i class="fas fa-user-md text-indigo-500 text-xs"></i></div>
                Doctor & Dentist Workload
            </h3>
            <div style="position:relative;height:250px"><canvas id="doctorWorkloadChart"></canvas></div>
        </div>

        <div class="bg-white rounded-2xl border border-gray-100 p-6 lg:col-span-2">
            <h3 class="flex items-center gap-2 text-sm font-bold text-gray-900 mb-4">
                <div class="w-7 h-7 bg-amber-50 rounded-lg flex items-center justify-center"><i class="fas fa-star text-amber-500 text-xs"></i></div>
                Patient Satisfaction Trend
            </h3>
            <div style="position:relative;height:200px"><canvas id="satisfactionTrendChart"></canvas></div>
        </div>
    </div>

    <!-- Additional Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
        <div class="bg-white rounded-2xl border border-gray-100 p-6">
            <h3 class="flex items-center gap-2 text-sm font-bold text-gray-900 mb-4">
                <div class="w-7 h-7 bg-red-50 rounded-lg flex items-center justify-center"><i class="fas fa-user-times text-red-500 text-xs"></i></div>
                No-Show Rate Analysis
            </h3>
            <div id="noShowStats">
                <div class="space-y-3 animate-pulse"><div class="h-4 bg-gray-100 rounded w-3/4"></div><div class="h-4 bg-gray-100 rounded w-1/2"></div><div class="h-4 bg-gray-100 rounded w-2/3"></div></div>
            </div>
        </div>

        <div class="bg-white rounded-2xl border border-gray-100 p-6">
            <h3 class="flex items-center gap-2 text-sm font-bold text-gray-900 mb-4">
                <div class="w-7 h-7 bg-emerald-50 rounded-lg flex items-center justify-center"><i class="fas fa-pills text-emerald-500 text-xs"></i></div>
                Top Medicine Usage
            </h3>
            <div id="inventoryConsumption">
                <div class="space-y-3 animate-pulse"><div class="h-10 bg-gray-100 rounded-xl"></div><div class="h-10 bg-gray-100 rounded-xl"></div><div class="h-10 bg-gray-100 rounded-xl"></div></div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    let charts = {};
    const chartFont = { family: 'Inter, sans-serif' };
    const chartDefaults = { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { font: chartFont } } }, scales: {} };

    async function loadOverview() {
        try {
            const r = await fetch('/analytics/api/overview');
            const d = await r.json();
            document.getElementById('statsGrid').innerHTML = `
                <div class="bg-white rounded-2xl border border-gray-100 p-5 hover:shadow-lg hover:shadow-blue-500/5 transition-all duration-300">
                    <div class="flex items-center justify-between mb-3">
                        <div class="w-11 h-11 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-md shadow-blue-500/20"><i class="fas fa-calendar-day text-white"></i></div>
                        <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2.5 py-1 rounded-lg">${d.today_completed||0} done</span>
                    </div>
                    <p class="text-2xl font-extrabold text-gray-900">${d.today_appointments||0}</p>
                    <p class="text-xs text-gray-400 mt-0.5">Today's Appointments</p>
                </div>
                <div class="bg-white rounded-2xl border border-gray-100 p-5 hover:shadow-lg hover:shadow-emerald-500/5 transition-all duration-300">
                    <div class="flex items-center justify-between mb-3">
                        <div class="w-11 h-11 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl flex items-center justify-center shadow-md shadow-emerald-500/20"><i class="fas fa-chart-line text-white"></i></div>
                        <span class="text-xs font-bold text-emerald-600 bg-emerald-50 px-2.5 py-1 rounded-lg">${d.monthly_visits||0} visits</span>
                    </div>
                    <p class="text-2xl font-extrabold text-gray-900">${d.monthly_appointments||0}</p>
                    <p class="text-xs text-gray-400 mt-0.5">This Month</p>
                </div>
                <div class="bg-white rounded-2xl border border-gray-100 p-5 hover:shadow-lg hover:shadow-violet-500/5 transition-all duration-300">
                    <div class="flex items-center justify-between mb-3">
                        <div class="w-11 h-11 bg-gradient-to-br from-violet-500 to-violet-600 rounded-xl flex items-center justify-center shadow-md shadow-violet-500/20"><i class="fas fa-hand-holding-medical text-white"></i></div>
                        <span class="text-xs font-bold text-violet-600 bg-violet-50 px-2.5 py-1 rounded-lg">Active</span>
                    </div>
                    <p class="text-2xl font-extrabold text-gray-900">${d.active_reservations||0}</p>
                    <p class="text-xs text-gray-400 mt-0.5">Active Reservations</p>
                </div>
                <div class="bg-white rounded-2xl border border-gray-100 p-5 hover:shadow-lg hover:shadow-amber-500/5 transition-all duration-300">
                    <div class="flex items-center justify-between mb-3">
                        <div class="w-11 h-11 bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl flex items-center justify-center shadow-md shadow-amber-500/20"><i class="fas fa-star text-white"></i></div>
                        <span class="text-xs font-bold text-amber-600 bg-amber-50 px-2.5 py-1 rounded-lg">${d.feedback_count||0} reviews</span>
                    </div>
                    <p class="text-2xl font-extrabold text-gray-900">${(d.avg_satisfaction||0).toFixed(1)}<span class="text-sm text-gray-400 font-normal">/5.0</span></p>
                    <p class="text-xs text-gray-400 mt-0.5">Avg Satisfaction</p>
                </div>`;
        } catch(e) { console.error(e); }
    }

    async function loadAppointmentsTrend() {
        try {
            const r = await fetch('/analytics/api/appointments-trend?days=30');
            const d = await r.json();
            if(charts.appointmentsTrend) charts.appointmentsTrend.destroy();
            charts.appointmentsTrend = new Chart(document.getElementById('appointmentsTrendChart'), {
                type:'line', data:{ labels:d.labels||[], datasets:[{ label:'Appointments', data:d.values||[], borderColor:'rgb(59,130,246)', backgroundColor:'rgba(59,130,246,0.08)', tension:.4, fill:true, pointRadius:3, pointHoverRadius:6 }] },
                options:{ ...chartDefaults, plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true,ticks:{stepSize:1,font:chartFont},grid:{color:'rgba(0,0,0,.04)'}}, x:{grid:{display:false},ticks:{font:chartFont}} } }
            });
        } catch(e) { console.error(e); }
    }

    async function loadServiceDistribution() {
        try {
            const r = await fetch('/analytics/api/service-distribution');
            const d = await r.json();
            if(charts.serviceDistribution) charts.serviceDistribution.destroy();
            if(!d.labels||d.labels.length===0){document.getElementById('serviceChartContainer').querySelector('div[style]').innerHTML='<div class="flex items-center justify-center h-full text-gray-400 text-sm"><div class="text-center"><i class="fas fa-chart-pie text-4xl mb-2 text-gray-200"></i><p>No data yet</p></div></div>';return}
            charts.serviceDistribution = new Chart(document.getElementById('serviceDistributionChart'), {
                type:'doughnut', data:{ labels:d.labels, datasets:[{ data:d.values, backgroundColor:['rgb(59,130,246)','rgb(16,185,129)','rgb(245,158,11)','rgb(239,68,68)','rgb(139,92,246)','rgb(236,72,153)','rgb(14,165,233)'], borderWidth:0 }] },
                options:{ ...chartDefaults, plugins:{legend:{position:'bottom',labels:{padding:12,font:{...chartFont,size:11},usePointStyle:true,pointStyle:'circle'}}} }
            });
        } catch(e) { console.error(e); }
    }

    async function loadPeakHours() {
        try {
            const r = await fetch('/analytics/api/peak-hours');
            const d = await r.json();
            if(charts.peakHours) charts.peakHours.destroy();
            charts.peakHours = new Chart(document.getElementById('peakHoursChart'), {
                type:'bar', data:{ labels:d.labels||[], datasets:[{ label:'Appointments', data:d.values||[], backgroundColor:'rgba(139,92,246,.8)', borderRadius:8, borderSkipped:false }] },
                options:{ ...chartDefaults, plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true,ticks:{stepSize:1,font:chartFont},grid:{color:'rgba(0,0,0,.04)'}}, x:{grid:{display:false},ticks:{font:chartFont}} } }
            });
        } catch(e) { console.error(e); }
    }

    async function loadDoctorWorkload() {
        try {
            const r = await fetch('/analytics/api/doctor-workload');
            const d = await r.json();
            if(charts.doctorWorkload) charts.doctorWorkload.destroy();
            if(!d.labels||d.labels.length===0){document.getElementById('doctorChartContainer').querySelector('div[style]').innerHTML='<div class="flex items-center justify-center h-full text-gray-400 text-sm"><div class="text-center"><i class="fas fa-user-md text-4xl mb-2 text-gray-200"></i><p>No data yet</p></div></div>';return}
            charts.doctorWorkload = new Chart(document.getElementById('doctorWorkloadChart'), {
                type:'bar', data:{ labels:d.labels, datasets:[{ label:'Appointments', data:d.values, backgroundColor:'rgba(99,102,241,.8)', borderRadius:8, borderSkipped:false }] },
                options:{ ...chartDefaults, indexAxis:'y', plugins:{legend:{display:false}}, scales:{ x:{beginAtZero:true,ticks:{stepSize:1,font:chartFont},grid:{color:'rgba(0,0,0,.04)'}}, y:{grid:{display:false},ticks:{font:chartFont}} } }
            });
        } catch(e) { console.error(e); }
    }

    async function loadSatisfactionTrend() {
        try {
            const r = await fetch('/analytics/api/satisfaction-trend?days=30');
            const d = await r.json();
            if(charts.satisfactionTrend) charts.satisfactionTrend.destroy();
            charts.satisfactionTrend = new Chart(document.getElementById('satisfactionTrendChart'), {
                type:'line', data:{ labels:d.labels||[], datasets:[{ label:'Avg Rating', data:d.values||[], borderColor:'rgb(245,158,11)', backgroundColor:'rgba(245,158,11,0.08)', tension:.4, fill:true, pointRadius:3 }] },
                options:{ ...chartDefaults, scales:{ y:{beginAtZero:true,max:5,ticks:{stepSize:.5,font:chartFont},grid:{color:'rgba(0,0,0,.04)'}}, x:{grid:{display:false},ticks:{font:chartFont}} } }
            });
        } catch(e) { console.error(e); }
    }

    async function loadNoShowRate() {
        try {
            const r = await fetch('/analytics/api/no-show-rate');
            const d = await r.json();
            const rate = (d.rate||0).toFixed(1);
            document.getElementById('noShowStats').innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl"><span class="text-sm text-gray-600">Total Scheduled</span><span class="font-bold text-gray-900">${d.total_scheduled||0}</span></div>
                    <div class="flex justify-between items-center p-3 bg-red-50 rounded-xl"><span class="text-sm text-red-700">No-Shows</span><span class="font-bold text-red-600">${d.no_shows||0}</span></div>
                    <div class="flex justify-between items-center p-3 rounded-xl ${parseFloat(rate)>10?'bg-red-50':'bg-emerald-50'}"><span class="text-sm ${parseFloat(rate)>10?'text-red-700':'text-emerald-700'}">Rate</span><span class="font-bold ${parseFloat(rate)>10?'text-red-600':'text-emerald-600'}">${rate}%</span></div>
                    <p class="text-xs text-gray-400 mt-2 flex items-center gap-1"><i class="fas fa-info-circle"></i>${d.no_shows||0} missed appointments in the past 30 days</p>
                </div>`;
        } catch(e) { console.error(e); }
    }

    async function loadInventoryConsumption() {
        try {
            const r = await fetch('/analytics/api/inventory-consumption?limit=5');
            const d = await r.json();
            if(!d||d.length===0){document.getElementById('inventoryConsumption').innerHTML='<div class="text-center py-8 text-gray-400 text-sm"><i class="fas fa-pills text-3xl mb-2 text-gray-200"></i><p>No usage data yet</p></div>';return}
            const colors=[{bg:'bg-blue-50',t:'text-blue-600'},{bg:'bg-emerald-50',t:'text-emerald-600'},{bg:'bg-violet-50',t:'text-violet-600'},{bg:'bg-amber-50',t:'text-amber-600'},{bg:'bg-pink-50',t:'text-pink-600'}];
            let html='<div class="space-y-2.5">';
            d.forEach((item,i)=>{const c=colors[i%colors.length];html+=`<div class="flex items-center justify-between p-3 ${c.bg} rounded-xl"><span class="font-medium text-sm text-gray-900">${item.medicine_name||'Unknown'}</span><span class="${c.t} font-bold text-sm">${item.count||0} uses</span></div>`});
            html+='</div>';
            document.getElementById('inventoryConsumption').innerHTML=html;
        } catch(e) { console.error(e); }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadOverview();
        loadAppointmentsTrend();
        loadServiceDistribution();
        loadPeakHours();
        loadDoctorWorkload();
        loadSatisfactionTrend();
        loadNoShowRate();
        loadInventoryConsumption();
    });
</script>
{% endblock %}
