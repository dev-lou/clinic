{% extends "admin_base.html" %}
{% set active_page = 'analytics' %}

{% block title %}Analytics Dashboard{% endblock %}

{% block content %}
<div class="p-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Analytics Dashboard</h1>
        <p class="text-gray-600">Comprehensive clinic performance metrics and insights</p>
    </div>

    <!-- Quick Stats Overview -->
    <div id="statsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Stats will be loaded here via JS -->
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Appointments Trend -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
                <i class="fas fa-chart-line text-blue-500 mr-2"></i>
                Appointments Trend
            </h3>
            <div style="position: relative; height: 250px;">
                <canvas id="appointmentsTrendChart"></canvas>
            </div>
        </div>

        <!-- Service Distribution -->
        <div id="serviceChartContainer" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
                <i class="fas fa-chart-pie text-green-500 mr-2"></i>
                Service Distribution
            </h3>
            <div style="position: relative; height: 250px;">
                <canvas id="serviceDistributionChart"></canvas>
            </div>
        </div>

        <!-- Peak Hours Heatmap -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
                <i class="fas fa-clock text-purple-500 mr-2"></i>
                Peak Hours
            </h3>
            <div style="position: relative; height: 250px;">
                <canvas id="peakHoursChart"></canvas>
            </div>
        </div>

        <!-- Doctor Workload -->
        <div id="doctorChartContainer" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
                <i class="fas fa-user-md text-indigo-500 mr-2"></i>
                Doctor & Dentist Workload
            </h3>
            <div style="position: relative; height: 250px;">
                <canvas id="doctorWorkloadChart"></canvas>
            </div>
        </div>

        <!-- Satisfaction Trend -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 lg:col-span-2">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
                <i class="fas fa-star text-yellow-500 mr-2"></i>
                Patient Satisfaction Trend
            </h3>
            <div style="position: relative; height: 200px;">
                <canvas id="satisfactionTrendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Additional Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- No-Show Rate -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
                <i class="fas fa-user-times text-red-500 mr-2"></i>
                No-Show Rate Analysis
            </h3>
            <div id="noShowStats">
                <!-- Stats will be loaded here -->
            </div>
        </div>

        <!-- Inventory Consumption -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
                <i class="fas fa-pills text-green-500 mr-2"></i>
                Top Medicine Usage
            </h3>
            <div id="inventoryConsumption">
                <!-- Stats will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Chart instances to destroy on reload
    let charts = {};

    // Load Overview Stats
    async function loadOverview() {
        try {
            const response = await fetch('/analytics/api/overview');
            const data = await response.json();
            
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-blue-100 text-sm font-medium">Today's Appointments</p>
                            <h2 class="text-3xl font-bold">${data.today_appointments || 0}</h2>
                        </div>
                        <i class="fas fa-calendar-day text-4xl text-blue-200"></i>
                    </div>
                    <p class="text-sm text-blue-100">${data.today_completed || 0} completed</p>
                </div>
                
                <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-green-100 text-sm font-medium">This Month</p>
                            <h2 class="text-3xl font-bold">${data.monthly_appointments || 0}</h2>
                        </div>
                        <i class="fas fa-chart-line text-4xl text-green-200"></i>
                    </div>
                    <p class="text-sm text-green-100">${data.monthly_visits || 0} visits completed</p>
                </div>
                
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-purple-100 text-sm font-medium">Active Reservations</p>
                            <h2 class="text-3xl font-bold">${data.active_reservations || 0}</h2>
                        </div>
                        <i class="fas fa-hand-holding-medical text-4xl text-purple-200"></i>
                    </div>
                    <p class="text-sm text-purple-100">Medicine pickups</p>
                </div>
                
                <div class="bg-gradient-to-br from-red-500 to-red-600 text-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-red-100 text-sm font-medium">Avg Satisfaction</p>
                            <h2 class="text-3xl font-bold">${(data.avg_satisfaction || 0).toFixed(1)}/5.0</h2>
                        </div>
                        <i class="fas fa-star text-4xl text-red-200"></i>
                    </div>
                    <p class="text-sm text-red-100">From ${data.feedback_count || 0} reviews</p>
                </div>
            `;
        } catch (error) {
            console.error('Error loading overview:', error);
            document.getElementById('statsGrid').innerHTML = '<p class="text-red-500">Error loading stats</p>';
        }
    }

    // Load Appointments Trend Chart
    async function loadAppointmentsTrend() {
        try {
            const response = await fetch('/analytics/api/appointments-trend?days=30');
            const data = await response.json();
            
            if (charts.appointmentsTrend) charts.appointmentsTrend.destroy();
            
            const ctx = document.getElementById('appointmentsTrendChart');
            charts.appointmentsTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels || [],
                    datasets: [{
                        label: 'Appointments',
                        data: data.values || [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error loading appointments trend:', error);
        }
    }

    // Load Service Distribution Chart
    async function loadServiceDistribution() {
        try {
            const response = await fetch('/analytics/api/service-distribution');
            const data = await response.json();
            
            if (charts.serviceDistribution) charts.serviceDistribution.destroy();
            
            // Check if there's data
            if (!data.labels || data.labels.length === 0) {
                document.getElementById('serviceChartContainer').innerHTML = `
                    <h3 class="text-lg font-bold text-gray-900 mb-4">
                        <i class="fas fa-chart-pie text-green-500 mr-2"></i>
                        Service Distribution
                    </h3>
                    <div style="position: relative; height: 250px;" class="flex items-center justify-center">
                        <div class="text-center text-gray-400">
                            <i class="fas fa-chart-pie text-5xl mb-3"></i>
                            <p>No appointment data yet</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            const ctx = document.getElementById('serviceDistributionChart');
            charts.serviceDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: [
                            'rgb(59, 130, 246)',
                            'rgb(16, 185, 129)',
                            'rgb(245, 158, 11)',
                            'rgb(239, 68, 68)',
                            'rgb(139, 92, 246)',
                            'rgb(236, 72, 153)',
                            'rgb(14, 165, 233)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error loading service distribution:', error);
        }
    }

    // Load Peak Hours Chart
    async function loadPeakHours() {
        try {
            const response = await fetch('/analytics/api/peak-hours');
            const data = await response.json();
            
            if (charts.peakHours) charts.peakHours.destroy();
            
            const ctx = document.getElementById('peakHoursChart');
            charts.peakHours = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels || [],
                    datasets: [{
                        label: 'Appointments',
                        data: data.values || [],
                        backgroundColor: 'rgb(139, 92, 246)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error loading peak hours:', error);
        }
    }

    // Load Doctor Workload Chart
    async function loadDoctorWorkload() {
        try {
            const response = await fetch('/analytics/api/doctor-workload');
            const data = await response.json();
            
            if (charts.doctorWorkload) charts.doctorWorkload.destroy();
            
            // Check if there's data
            if (!data.labels || data.labels.length === 0) {
                document.getElementById('doctorChartContainer').innerHTML = `
                    <h3 class="text-lg font-bold text-gray-900 mb-4">
                        <i class="fas fa-user-md text-indigo-500 mr-2"></i>
                        Doctor & Dentist Workload
                    </h3>
                    <div style="position: relative; height: 250px;" class="flex items-center justify-center">
                        <div class="text-center text-gray-400">
                            <i class="fas fa-user-md text-5xl mb-3"></i>
                            <p>No doctors/dentists assigned yet</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            const ctx = document.getElementById('doctorWorkloadChart');
            charts.doctorWorkload = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Appointments',
                        data: data.values,
                        backgroundColor: 'rgb(99, 102, 241)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error loading doctor workload:', error);
        }
    }

    // Load Satisfaction Trend Chart
    async function loadSatisfactionTrend() {
        try {
            const response = await fetch('/analytics/api/satisfaction-trend?days=30');
            const data = await response.json();
            
            if (charts.satisfactionTrend) charts.satisfactionTrend.destroy();
            
            const ctx = document.getElementById('satisfactionTrendChart');
            charts.satisfactionTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels || [],
                    datasets: [{
                        label: 'Average Rating',
                        data: data.values || [],
                        borderColor: 'rgb(245, 158, 11)',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5,
                            ticks: {
                                stepSize: 0.5
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error loading satisfaction trend:', error);
        }
    }

    // Load No-Show Rate
    async function loadNoShowRate() {
        try {
            const response = await fetch('/analytics/api/no-show-rate');
            const data = await response.json();
            
            document.getElementById('noShowStats').innerHTML = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Total Scheduled</span>
                        <span class="font-bold text-gray-900">${data.total_scheduled || 0}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">No-Shows</span>
                        <span class="font-bold text-red-600">${data.no_shows || 0}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Rate</span>
                        <span class="font-bold text-red-600">${(data.rate || 0).toFixed(1)}%</span>
                    </div>
                    <div class="mt-4 p-4 bg-red-50 rounded-lg">
                        <p class="text-sm text-red-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            ${data.no_shows || 0} appointments were missed in the past 30 days.
                        </p>
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading no-show rate:', error);
        }
    }

    // Load Inventory Consumption
    async function loadInventoryConsumption() {
        try {
            const response = await fetch('/analytics/api/inventory-consumption?limit=5');
            const data = await response.json();
            
            if (!data || data.length === 0) {
                document.getElementById('inventoryConsumption').innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-pills text-5xl mb-3"></i>
                        <p>No medicine usage data yet</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="space-y-3">';
            data.forEach((item, index) => {
                const colors = [
                    { bg: 'bg-blue-50', text: 'text-blue-600' },
                    { bg: 'bg-green-50', text: 'text-green-600' },
                    { bg: 'bg-purple-50', text: 'text-purple-600' },
                    { bg: 'bg-orange-50', text: 'text-orange-600' },
                    { bg: 'bg-pink-50', text: 'text-pink-600' }
                ];
                const color = colors[index % colors.length];
                html += `
                    <div class="flex items-center justify-between p-3 ${color.bg} rounded-lg">
                        <span class="font-medium text-gray-900">${item.medicine_name || 'Unknown'}</span>
                        <span class="${color.text} font-bold">${item.count || 0} uses</span>
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('inventoryConsumption').innerHTML = html;
        } catch (error) {
            console.error('Error loading inventory consumption:', error);
        }
    }

    // Load all data on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadOverview();
        loadAppointmentsTrend();
        loadServiceDistribution();
        loadPeakHours();
        loadDoctorWorkload();
        loadSatisfactionTrend();
        loadNoShowRate();
        loadInventoryConsumption();
    });
</script>
{% endblock %}